---
title: "XLUM-file format Documentation"
author: "Sebastian Kreutzer, Steve Grehl, Michael Höhne,...\\<further authors\\>"
date: "version: 1.0 [`r Sys.Date()`]"
output:
  # word_document:
  #   toc: yes
  # bookdown::pdf_document2:
  #    toc: yes
  #    number_sections: true
  bookdown::html_document2: 
     theme: simplex
     toc: yes
     number_sections: true
     toc_float:
       collapsed: yes
       smooth_scroll: yes
---

# Motivation and principles

This document details the `XLUM` format, an XML based file format for long-term data preservation and exchange of luminescence data. The format is readable by humans and machines, and the data can be easily checked with any text reader on any major operating system. This design allows a platform-independent operation. The following documentation provides essential information on the file `XLUM` format  and accounts for the needs for individual flexible data analysis, even with 
self-written software applications.

Three simple design principles underpin the format specification:

* Stored are data recorded over **time** or time derived instances, 
* stored are data on a technical component level, 
* data stored in a file are self-consistent.

# General description

The `XLUM`-format is an [XML](https://www.w3.org/xml) derivative. The base data structure is a 
tree with five nodes storing the data. Each level has its unique denotation.

The levels and a short introduction is given in the table below. A detailed description can be found in the following sections. 
Nodes represent each level in the structure. **Only `<curve>` nodes contain physical quantities, such as luminescence data** all other nodes are parent nodes of `<curve>` 
to structure the dataset and ship additional metadata. 

The first level, `xlum` is a supernode to enable storage of luminescence data in arbitrary files following the XML scheme. As a side effect this 
also allows custom file endings different from `*.xlum`.


  |Node name       | Number of samples   |Number of aliquots  | Number of records  | Number of data curves |
  |:---------------|:--------------------|:-------------------|:-------------------|:----------------------|
  `<xlum>`         |$\inf$               |$\inf$              |$\inf$              |$\inf$  
  `<sample>`       |1                    |$\inf$              |$\inf$              |$\inf$
  `<sequence>`     |1                    |1                   |$\inf$              |$\inf$
  `<record>`       |1                    |1                   |1                   |$\inf$
  `<curve>`        |1                    |1                   |1                   | 1  

  Table: Node overview

A node has a name, attributes, and data stored in it. The data stored in the attributes describe the state of this level. The stored data in the node describes the process(es) assigned to the node. A minimal example is shown in the listing. The documentation provides an overview starting with the leaf node description and going up to the root from there. Further notes:

* The format version bases on [XML version 1.0 (Fith Edition)](http://www.w3.org/TR/2008/REC-xml-20081126/)
* File encoding should always be UTF-8
* This specification lists only mandatory attributes. Additional, custom attributes are explicitly supported.
* Parser supporting the `XLUM` format must not crash when encountering non-specified node attributes. However, they may skip them.

```{r, engine='bash', eval = FALSE}
<?xml version="1.0" encoding="UTF-8"?>
<xlum>
  <sample>
    <sequence>
      <record>
        <curve> 
          1,2,...,n
        </curve>
      </record>
    </sequence>
  </sample>
</xlum>
```

# Detailed description

## The `<curve>` level

The `curve` level is the deepest node (leaf) and has no further sub-levels. 
A curve holds the predefined/simulated or measured output of one single 
technical component. For example, a typical thermoluminescence measurement 
may consist of one or many curves.

 1. **The three curve example**: (a) Time against temperature recorded by a thermocouple 
 (temperature sensor), (b) time against photon counts recorded by a photomultiplier tube, 
 (c) time against a predefined heating ramp.
 2. **The one curve example**: Time against temperature. In this case temperature
 is a processed quantity, because measurements happen over a time instant. However, for
 compatibility reasons, this would be allowed although it is not preferred.

In both cases, all mentioned `curve` nodes belong to one parent `record`. In case 1, 
the record contains one curve and three in case 2. Ideally, curves represent technical 
components and not processed quantities. 

### Value storage

Values in the `<curve>` node are stored comma separated. **Only quantities detected
by a detector/sensor are stored in this node.** This includes simulated values. 
Figure \@ref(fig:fig1) shows three types of (luminescence) detectors, distinguished by their capacity to record spatially resolved information. 
Regardless of the detector, recorded quantities are stored in the `<curve>` node 
separated by a comma. Example: 

```{r, engine='bash', eval = FALSE}
<curve>59.5167,109.5164,149.7003,109.5170,156.2654</curve>
```

Values in the node are real numbers (-1e-307 $\leqslant x \leqslant$ 1e+307; $x \in \mathbb{R}$).
Scientific 'E'/'e' notations of numbers are explicitly allowed, example: 1e+2 for 100 or 1e-2 for 0.01.
Decimal separator is a `.` (dot).

For consistency reasons, the value in the node span an array with dimensions 
defined through the node attributes `xValues`, `yValues` and `tValues` (see Fig. \@ref(fig:fig1)).

```{r fig1, echo=FALSE, fig.align='center', fig.cap="The three cases for data storage depending on the detector. The black solid arrows indicate how the array is constructed from the values stored in the node."}
knitr::include_graphics("img/Curve_Level_Storage.png", auto_pdf = TRUE, dpi = 300)
```

1. The simplest form is a detector that records no spatial information. For instance,
a photomultiplier tube only knows about count recorded over time. Alternatively, the
detector can be any sensor, measuring, e.g., temperature, pressure or current. 

2. A spectrometer (here a camera in front of a spectrograph) is another type of 
detector with spatial information, here wavelengths split by the spectrograph 
hitting different pixel areas of the detector. 

3. The most complex from is a detector that records events (e.g., luminescence), 
spatially resolved. Such as a camera. 

In the examples and the Fig.\@ref(fig:fig1) the detectors detect luminescence, 
however, any type of sensor, electronic component recording information of
relevance for the measurement of luminescence are suitable. Typical examples:

* Temperature sensor (thermocouple), recording the temperature of the heating element
* Photo diode, monitoring the optical power density at the sample position
* Resistor, measuring the current of a LED
* Pressure sensor, monitoring the atmosphere in the measurement chamber
* Inductive sensor, monitoring closing and opening of a shutter

### Node attributes

  |Identifier       |Type        |Allows `NA`?   |Example               |Information   |
  |:----------------|:-----------|:---------|:-------------------------|:---------------------|
  component         | `string`   |yes            |`"EMI 9235QB15"`     | name of the technical component. `NA` allowed only for `"predefined"` |
  startDate         | `date`     |no             |`"2021-07-14T22:59:35.0Z"`      | ISO 8601-1:2019: `YYYY-MM-DDThh:mm:ss[.mmm]Z` recalculated to Zulu time |
  curveType         | `string`   |no             |`"predefined"`                  | Values allowed are only `"predefined"` or `"measured"`    |
  duration          | `number`   |no             |`"20.000"`                      | Duration of the detection in seconds or a fraction of it|
  offset            | `number`   |no             |`"10.000"`                      | Before the detection starts in seconds or a fraction of it|
  xValues           | `number`   |yes            |`"1.0,2.0,3.0"`                 | x-coordinate values of the detector                       |
  yValues           | `number`   |yes            |`"1.0,2.0,3.0"`                 | y-coordinate values of detector                           |
  tValues           | `number`   |no             |`"1.0,2.0,3.0"`                 | time values in seconds or fractions of it. Values must be positive|
  vLabel            | `string`   |no             |`"Luminescence"`                | Measured physical quantity                                |
  xLabel            | `string`   |yes            |`"pixel"`                       | label of the x-coordinate values                          |
  yLabel            | `string`   |yes            |`"pixel"`                       | label of the y-coordinate values                          |  
  tLabel            | `string`   |no             |`"time"`                        | label of t-values, usually 'time'                         |
  vUnit             | `string`   |no             |`"cts"`                         | label of the v-values, for luminescence usually photon counts
  xUnit             | `string`   |yes            |`"nm"`                          | SI unit or equivalent for x-values                        |
  yUnit             | `string`   |yes            |`"px"`                          | SI unit or equivalent for y-values                        |
  tUnit             | `string`   |no             |`"s"`                           | SI unit or equivalent for t-values                        |
  [detectionWindow] | `string`   |no             |`"375"`                         | Centre wavelength if applicable. can be set to `NA`    |
  [filter]          | `list` (`string`) |no      |`"Hoya U340; Delta BP 365/50EX"`| Filter names separated by `;` |

  Table: Specified curve attributes. Attributes in `[]` are optional, hence `NA` is not allowed.

### Example 

In order to define a suitable standard only a few attributes are required. A few of them are useful for every kind of component, 
others are only meaningfully in combination. For instance, providing information on the detection window is not meaningful for 
a heating element. 

```{r, engine='bash', eval = FALSE}
{...}
  <curve component="heating element" startDate="2021-02-14T225700.0Z" curveType="predefined" duaration="5" 
    offset="0" xValues="NA" yValues="NA" vLabel="temperature" tValues="1,2,3,4,5" xLabel="NA" yLabel="NA"
    tLabel="time" vLabel="temperature" xUnit="" yUnit="" vUnit="K" tUnit="s">
        293,303,313,323,333
  </curve>
  <curve component="thermo couple" startDate="2021-02-14T225700.0Z" curveType="measured" duaration="5" 
    offset="0" xValues="NA" yValues="NA" tValues="1,2,3,4,5" xLabel="NA" yLabel="NA"
    vLabel="temperature" tLabel="time" xUnit="" yUnit="" vUnit="K" tUnit="s">
        293,303,313,323,333
  </curve>
  <curve component="EMI 9123QB15" startDate="2021-02-14T225700.0Z" curveType="measured" duaration="5" 
    offset="0" xValues="NA" yValues="NA" tValues="1,2,3,4,5" xLabel="NA" yLabel="NA"
    vLabel="luminescence" tLabel="time" xUnit="" yUnit="" vUnit="cts" tUnit="s" 
    detectionWindow="380 nm" filter="Hoya U340 + Delta 365/40">
        20,25,32,41,46
  </curve>
{...}
```

One curve is related to one technical device. To define a accurate time window, 
the parameters *duration* and *offset* should be used. These parameters are related to the 
start of the parent `<record>` node.

## The `<record>` level

A `<record>` defines one process involving many components, hence `<record>` may 
contain $1\leq n\leq Inf; n \in \mathbb{Z}$ `<curve>` nodes.  A record can also be understood 
as one step in a measurement sequence, e.g., a TL measurement. All curves within the record should have been 
detected within the same time frame defined through the attributes `<startDate>` and `<endDate>`.

### Attributes

  |Identifier          | Type          |Allows `NA`? | Example        |Information  |
  |:-------------------|:--------------|:------------|:---------------|:------------|
  |startDate           | `date`        |no           |`"2021-07-14T22:59:35.0Z"`     | ISO 8601-1:2019: `YYYY-MM-DDThh:mm:ss[.mmm]Z` recalculated to Zulu time. Time when the record starts |
  |endDate             |`date`         |no          |  `"2021-07-14T22:59:35.0Z"`     | ISO 8601-1:2019: `YYYY-MM-DDThh:mm:ss[.mmm]Z` recalculated to Zulu time. Time when this measurement step was finished |
  |recordType          |`string`       |no          |  `"TL"`                  |  valid values according the `recordType` table                 |
  |description         |`string`       |yes         | `"green stimulated luminescence"` | allows a longer description of the record |
  |comment             |`string`       |yes         | `"measured with joy"`    | free text field for additional comments on the record |
  |sequenceStepNumber  |`integer`      |yes         |  `5`                     |  index in the sequence     |
  |sampleCondition     |`string`       |yes         |  dose                    | valid values according to the table below |
  
  Table: Allowed attributes for `<record>` node.

The `recordType` names are not carved in stone, but should be chosen to best describe a record in one
word or using an accepted abbreviation (e.g., OSL for optically stimulated luminescence). 
However, it is important to keep in mind that the `recordType` makes **no** claim on the technical 
components involved, but is solely set to ease the understanding of the record. The hard 
physical information a stored in the `<curve>` node.

  |`recordType`          | Information      |
  |:---------------------|:----------------------------------------|
  |`"bleaching"`         | any kind of bleaching                   |
  |`"irradiation"`       | irradiation with ionising source        |
  |`"atmosphereExchange"`| atmosphere exchange                     |
  |`"heating"`           | any kind for heating without signal detection       |
  |`"spectrometer"`      | spectrometer                            |
  |`"camera"`            | camera, e.g. any kind of imaging other than spectrometry      |
  |`"TL"`                | thermoluminescence measurement                     | 
  |`"ITL"`               | Isothermal luminescence                  | 
  |`"TM-OSL"`            | thermally modulated luminescence                 |
  |`"RF"`                | radiofluorescence                                  |
  |`"UV-RF"`             | radiofluorescence with detection in the UV wavelength range    |
  |`"IR-RF"`             | radiofluorescence with detection in the infrared wavelength range    |
  |`"IR-PL"`             | infrared photoluminescence    |
  |`"OSL"`               | optically stimulated luminescence                    |
  |`"GSL"`               | green optically stimulated luminescence                    |
  |`"VSL"`               | violet optically stimulated luminescence                    |
  |`"YSL"`               | yellow optically stimulated luminescence                    |
  |`"POSL"`              | pulsed optical stimulated luminescence               |
  |`"pause"`             | pause     |
  |`"custom"`            | any undefined or custom record type  not listed above   |
  
  Table: Valid `recordTypes`

valid entries for  `sampleConditions` are:

  |`sampleCondition`   |  Information        |
  |:-------------------|:--------------------|
  |`"Natural"`            | Natural          |
  |`"Natural+Dose"`       |Natural+Dose     |
  |`"Bleach"`             |  Bleach  |
  |`"Bleach+Dose"`        |  Bleach+Dose  |
  |`"Nat.(Bleach)"`       |  Nat.(Bleach)  |
  |`"Nat.+Dose(Bleach)"`  |  Nat.+Dose(Bleach) |
  |`"Dose"`               |  Dose  |
  |`"Background"`         |  Background |
  
  Table: Valid values for `sampleConditions`
  
*Please note that the attribute `sampleCondition` is of informative nature, accounting
for information stored in BIN/BINX-files. The field can be set to `NA`.*

### Example 

The following examples consists of two records. 

```{r, engine='bash', eval = FALSE}
{...}
    <record startDate="2021-02-14T22:59:35.0z" endDate="2021-02-14T23:10:00.0z"
       recordType="GSL" description="green OSL CW" comment="standard green OSL step"
       sequenceStepNumber="1" sampleCondition="NA">
      <curve {...}>
        {...}
      </curve>
      <curve {...}>
        {...}
      </curve>
    </record>
    <record startDate="2021-02-14T23:10:10.0z" endDate="2021-02-14T23:20:00.0z"
       recordType="bleach" description="bleaching with solar simulator" comment="NA"
       sequenceStepNumber="2" sampleCondition="NA">
        <curve {...}>
          {...}
        </curve>
    </record>
{...}
```

## The `<sequence>` level

A sequence describes multiple measurements sequentially used at **one** aliquot, 
for instance as cup/disc with multiple grains or a single grain. Naturally the
information stored an that level can be very verbose, so the attributes 
are limited to a meaningful minimum. 

### Attributes

  |Identifier     |Type         |  Allows `NA`?    |  Example                | Information        |
  |:------------- |:------------|:-----------------|:------------------------|:-------------------|
  |startDate      |`Date`       |no                |`"2021-08-14T22:59:35.0Z`| start date of the sequence (can be identical with first `<record>` and `<curve>` entry)
  |position       |`numeric`    |no                |`"42"`                   | position of aliquot in the reader, can be `1` in case samples are changed manually |
  |name           |`string`     |yes               |`"SAR measurement"`      | name of the sequence |
  |fileName       |`string`     |yes               |`"SAR_OSL.seq"`          | sequence file so far applicable |
  |software       |`string`     |yes               |`"Sequence Editor 4.4"`  | software used to write the sequence if applicable |
  |comment        |`String`     |yes                |`"just a test sequence"` | any comment on the sequence  |
  
  Table: Mandatory attributes `<sequence>` node

In the luminescence context a sequence can fit a SAR protocol. It is
defined that all measurements hold by one sequence are made with one
aliquot.

### Example

```{r, engine='bash', eval = FALSE}
<Sequence state="finished" parentID="1010071454551909" name="TL spectra Feldspar" position="18" comment="" creationDate="20131007145455" protocol="" mineral="">
  {...}
</Sequence>
```

## The `<sample>` level

The sample builds the top level. In one file is always only one sample
stored. It defines the parameter of the used system.

### Attributes 

  |identifier         |data type / structure  | example                          | information            |
  |------------------ |-----------------------| ---------------------------------| ------------------------------------------|
  |name               |`number`                 | analyse of Hanburg/Germany/1989  |  user given name           |
  |user               |`String`                 | Jane Doe                         |  name of the person in authority     |
  |startDate          |`Date`                   | 20130217100242                  |  start of the analyse     |
  |sampleCarrier      |`String`                 | unknown                          | used sample carrier    |
  |lexsyg           |`number`                 | 201312                          |  ID to identify the used measurement system|
  |lexStudioVersion   |`decimal`                | 1.0                              | version of the used measurement software|
  |firmwareVersion    |`decimal`                | 0.6                             |  version of the firmware in the lexsyg system |
  |os                 |`String`                 | aluminium oxide                  | operating system of the computer |


### Example 

```{r, engine='bash', eval = FALSE}
<Sample state="finished" parentID="0" name="TL spectra Feldspar" user="" 
    startDate="20131007145455" sampleCarrier="" leXLUMID="11-re-01-0006" 
    lexStudioVersion="Lexstudio 2beta 0.15.0" 
    firmwareVersion="unknown" os="Microsoft Windows NT 6.1.7601 Service Pack 1" comment="">
    {...}
</Sequence>
```

## The `<xlum>` level 

The `<xlum>` is the format parent node 

### Attributes

|Identifier   |Type           |Allows `NA`? |Example                |Information   |
|:------------|:--------------|:---------|:-------------------------|:--------------|
xml:lang      |`string'`      |no        |: *predefined*            | ISO 639-1 language code, must not be changed
version       |`numeric`      |no        |`"1.0"`                   | The `xlum` format version number relevant |
flavour       |`string`       |no        |`"generic"`               | Allows to specify a particular flavour of the format
author        |`list(string)` |yes       |`"Max Planck; Marie Curie"` | Names of the author(s) of this dataset
license       |`string`       |yes       |`"CC BY 4.0"`               | License for the distribution of the dataset.
doi           |`string`       |yes       |`"10.5281/zenodo.596252"`   | A digital document identifier referencing the dataset already archive in a data repository


### Example

```{r, engine='bash', eval = FALSE}
{...}
<xlum xml:lang="en" formatVersion="1.0" flavour="generic" author="Marie Curie" 
  license="CC BY 4.0" doi="NA">
{...}
```

## General parameters

There are a few parameters that are stored on every level.

  |identifier   |data type / structure  | example                             |information      |
  |------------ |-----------------------| ----------------------------------- |----------------------------------|
  |state        |`enumeration`            | analyse of Hanburg/Germany/1989     |Values: {finished, recording, …} |
  |parentID     |`number`                 | 201007145551910                     |ID of the parent node  |
  |comment      |`String`                 | measurement to verify a assumtion   |   |
  
## Pulsing data

In measurements with pulsed light stimulation, multiple detector curves might be stored per record, one for each (x) pulse(-s).
The record contains some additional Metadata

  |identifier        | data type    |example    |information            |
  |------------------| ------------ |---------- |---------------------------------------|
  |OnTime           |  `number`      | 1E-01     | on time of stimulation per pulse, [s]     |
  |OffTime          |  `number`      |  1E-01   |   on time of stimulation per pulse, [s]    |
  |NrPulses         |  `number`      |  10      |   number of stimulation pulses total     |
  |Summations       |  `number`     |  2        |  how many consecutive pulse records are summated (e.g. 10 pulses, 2 summations -> 5 records) |
  |ChannelsPerPulse |  `number`     |  1000      | number of channels that are recorded in one curve      |
  |CountsNormalized  | `number`      | 1        |  if not 0, counts per channel are normalized to counts per second (helpful with uneven distributed channel times) |
  
Also the curves contain additional metadata

  |identifier         |data type   | example    |information |
  |------------------ |------------| ---------- |---------------------------------------|
  |PulseNr            |`number`      |1          | current Pulse |
  
Pulsing Curves typically contain value pairs of channel time in microseconds and counts, see curveDescripter.

# Practical guidlines

An import function must not crash parsing the following minimal example.

```{xml, engine='bash', eval = FALSE, tidy=FALSE}
<?xml version="1.0" encoding="utf-8"?>
<Sample>
  <Sequence>
    <Record>
      <Curve>
      </Curve>
    </Record>
  </Sequence>
</Sample>
```
